<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>ভাণ্ড - File Storage</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {

            font-family: Arial, sans-serif;
            background: #f0f2f5;
            padding: 40px;
            margin: 0;
        }
        /* === Bulk Selection & Checkbox Styles === */
.checkbox-container {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
}
.checkbox-container input {
    margin: 0;
    transform: scale(1.1);
}
.file-item .checkbox-container,
.folder .checkbox-container {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 4px;
    border-radius: 4px;
    opacity: 0;
    transition: opacity 0.2s;
}
.folder:hover .checkbox-container,
.file-item:hover .checkbox-container,
.folder.selected .checkbox-container,
.file-item.selected .checkbox-container {
    opacity: 1;
}
/* Selected highlight */
.folder.selected,
.file-item.selected {
    border-color: #2e86de;
    background: #e1f0ff;
}
/* Export Button */
#exportZipBtn {
    background-color: #27ae60;
    width: auto;
}
#exportZipBtn:hover {
    background-color: #219653;
}
        /* Thumbnail Styles */
        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            flex-shrink: 0;
        }
        .thumbnail-placeholder {
            width: 60px;
            height: 60px;
            background: #e0e0e0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
            text-align: center;
            flex-shrink: 0;
        }
        .file-preview-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .file-preview-container h3 {
            margin: 0;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: #333;
        }

        h1 {
            margin: 0;
            font-style: italic;
            color: #555;
        }

        /* === Two-Column Layout === */
        .main-content {
            display: flex;
            gap: 30px;
            height: 600px;
        }

        .left-panel {
            flex: 1;
            border-right: 1px solid #ddd;
            padding-right: 20px;
            overflow-y: auto;
        }

        .right-panel {
            flex: 1;
            padding: 20px;
            background: #f9f9fb;
            border-radius: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Controls and Search */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-filter {
            display: flex;
            gap: 10px;
        }

        .search-filter input,
        .search-filter select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }

        .btn {
            display: inline-block;
            padding: 10px 15px;
            font-size: 14px;
            background: #2e86de;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn:hover {
            background: #1b4f72;
        }

        #backBtn {
            background-color: #6c757d;
            width: auto;
        }

        #backBtn:hover {
            background-color: #5a6268;
        }

        .logout-btn {
            background: #d63031;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #b71c1c;
        }

        /* === Navigation Bar === */
        #navigation-bar {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .nav-link {
            cursor: pointer;
            color: #007bff;
            text-decoration: none;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .nav-separator {
            margin: 0 8px;
            color: #6c757d;
        }

        .nav-current {
            font-weight: bold;
            color: #343a40;
        }

        /* File & Folder Items */
        .folder,
        .file-item {
            background: #f9f9f9;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #eee;
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .folder:hover,
        .file-item:hover {
            background: #eef5ff;
            border-color: #2e86de;
        }

        .folder.selected,
        .file-item.selected {
            border: 2px solid #2e86de;
            background: #e1f0ff;
        }

        .folder h3,
        .file-item h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .folder-icon {
            margin-right: 8px;
        }

        /* Double-click hint */
        .folder::after,
        .file-item::after {
            content: 'Double-click to open';
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
            color: #888;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .folder:hover::after,
        .file-item:hover::after {
            opacity: 0.7;
        }

        /* Preview Styles */
        .preview-header {
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: #333;
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
        }

        .preview-content img {
            width: 100%;
            height: 400px;
            object-fit: contain;
            border-radius: 6px;
            margin: 10px 0;
            background: #f0f0f0;
            border: 1px solid #ddd;
        }

        .preview-content textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            font-family: monospace;
        }

        .preview-folder-summary {
            line-height: 1.8;
        }

        .preview-empty {
            color: #aaa;
            font-style: italic;
            text-align: center;
            margin-top: 40%;
        }
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            color: #aaa;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .drop-zone.dragover {
            background-color: #f0f8ff;
            border-color: #2e86de;
        }

        .storage-meter-container {
            margin-bottom: 20px;
        }

        .progress-bar-background {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            height: 20px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar-foreground {
            width: 0%;
            height: 100%;
            background-color: #2e86de;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }

        #usageText {
            font-weight: bold;
            color: #555;
        }

        /* Actions */
        .actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
        }

        .folder:hover .actions,
        .file-item:hover .actions,
        .folder.selected .actions,
        .file-item.selected .actions {
            display: block;
        }

        .rename-btn,
        .delete-btn {
            background: #ffc107;
            color: black;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .delete-btn {
            background: crimson;
            color: white;
        }

        .rename-btn:hover {
            background: #e0a800;
        }

        .delete-btn:hover {
            background: darkred;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 99;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
        }

        .modal-content label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }

        .modal-content input,
        .modal-content select {
            width: 95%;
            margin-top: 5px;
            padding: 8px;
            margin-bottom: 10px;
        }

        .modal-content .btn {
            width: 100%;
        }

        .close {
            float: right;
            font-size: 22px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="loading-overlay" id="loadingOverlay"><span>Loading...</span></div>
        <div class="header">
            <h1 id="page-title"></h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
        <!-- Add to HTML -->
        <div class="controls">

        <div id="navigation-bar"></div>

        <!-- Two-Panel Layout -->
        <div class="main-content">
            <!-- Left Panel: File System -->
            <div class="left-panel">
                <div class="controls">
                    <div class="btn-group" style="display: flex; gap: 10px;">
                        <button class="btn" id="backBtn">← Back</button>
                        <button class="btn" id="openModalBtn">+ Upload</button>
                        <button class="btn" id="createFolderBtn">📁 New Folder</button>
<button class="btn" id="exportZipBtn">📦 Export Selected as ZIP</button>
                    </div>
                    <div class="search-filter">
                        <input type="text" id="searchInput" placeholder="Search files (all folders)..." />
                        <select id="filterSelect">
                            <option value="all">All Files</option>
                            <option value="folders">Folders</option>
                            <option value="images">Images</option>
                            <option value="documents">Documents (.txt, .pdf, .md)</option>
                            <option value="videos">Videos</option>
                            <option value="audio">Audio</option>
                            <option value="archives">Archives</option>
                        </select>
                    </div>
                </div>
                <div class="drop-zone" id="dropZone">
                    Drag & Drop files here to upload
                </div>
                <div id="fileList"></div>
            </div>
            <!-- Right Panel: Preview -->
            <div class="right-panel">
                <h3 class="preview-header" id="previewHeader">Welcome</h3>
                <div class="preview-content" id="previewContent">
                    <div class="preview-empty">Select a file or folder to preview</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Upload Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">×</span>
            <h3>Upload Files</h3>
            <label for="fileInput">Select File(s):</label>
            <input type="file" id="fileInput" accept="*" multiple />
            <label for="folderSelect">Select Folder:</label>
            <select id="folderSelect"></select>
            <button class="btn" id="uploadBtn">Upload</button>
        </div>
    </div>
    
 <script>
    const SUPABASE_URL = 'https://prpeuaaloxdjnbcixdxc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBycGV1YWFsb3hkam5iY2l4ZHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTc3NDQsImV4cCI6MjA2OTg5Mzc0NH0.YcGaYM34RB_aXZ-RD3vAQXh70OK33e19QLzVrhCU2V4';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET_NAME = 'uploads';

    // DOM Elements
    const backBtn = document.getElementById('backBtn');
    const openModalBtn = document.getElementById('openModalBtn');
    const createFolderBtn = document.getElementById('createFolderBtn');
    const exportZipBtn = document.getElementById('exportZipBtn');
    const uploadModal = document.getElementById('uploadModal');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const folderSelect = document.getElementById('folderSelect');
    const fileList = document.getElementById('fileList');
    const logoutBtn = document.getElementById('logoutBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const dropZone = document.getElementById('dropZone');
    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');

    // Preview Elements
    const previewHeader = document.getElementById('previewHeader');
    const previewContent = document.getElementById('previewContent');

    let currentUser = null;
    let fileSystem = {};
    let currentPath = 'root';
    let selectedFile = null;
    let allFiles = [];
    let isNavigatingFromHistory = false;

    // Bulk Selection
    let selectedItems = new Set(); // Store selected file/folder paths

    function showLoader(message = 'Loading...') {
        loadingOverlay.firstElementChild.textContent = message;
        loadingOverlay.style.display = 'flex';
    }

    function hideLoader() {
        loadingOverlay.style.display = 'none';
    }
    function checkScreenSize() {
    if (window.innerWidth < 768 && isWidgetOpen) {
        storageWidget.style.maxHeight = '40px';
        storageWidgetToggle.textContent = '📊';
        isWidgetOpen = false;
    }
}
window.addEventListener('resize', checkScreenSize);
checkScreenSize();
    document.addEventListener('DOMContentLoaded', async () => {
        const pageTitle = document.getElementById('page-title');
        const quotes = [
            "\"Less is more.\"", "\"Stay hungry, stay foolish.\"", "\"What you seek is seeking you.\"",
            "\"Be consistent in not being inconsistent.\"", "\"Be yourself; everyone else is already taken.\"",
            "\"Happiness depends upon ourselves.\"", "\"Act, don't react.\"", "\"The obstacle is the way.\"",
            "\"Dream big. Start small.\"", "\"Simplicity is the ultimate sophistication.\"", "\"Do it scared.\""
        ];
        const randomIndex = Math.floor(Math.random() * quotes.length);
        pageTitle.textContent = quotes[randomIndex];

        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (error || !session) {
            window.location.href = 'login.html';
            return;
        }
        currentUser = session.user;

        initializeBrowserHistory();
        await refreshFileSystem();
    });

    // STORAGE USAGE
    const STORAGE_LIMIT_GB = 1;
    const STORAGE_LIMIT_BYTES = STORAGE_LIMIT_GB * 1024 * 1024 * 1024;

    function formatBytes(bytes, decimals = 2) {
        if (!bytes || bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function updateUsageMeter(fileListData) {
    const usageText = document.getElementById('usageText');
    const usageProgressBar = document.getElementById('usageProgressBar');
    const totalUsage = fileListData
        .filter(item => !item.is_folder && item.size)
        .reduce((sum, item) => sum + item.size, 0);

    const usagePercentage = (totalUsage / STORAGE_LIMIT_BYTES) * 100;
    usageText.textContent = `${formatBytes(totalUsage)} / ${STORAGE_LIMIT_GB} GB Used`;
    usageProgressBar.style.width = `${Math.min(usagePercentage, 100)}%`;

    // Render chart
    renderStorageChart(fileListData);
}
    let storageChart = null; // Global reference


function renderStorageChart(fileListData) {
    const ctx = document.getElementById('storageChart').getContext('2d');

    // Define file type categories
    const categories = {
        Images: /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i,
        Documents: /\.(pdf|txt|md|docx?|pptx?|xlsx?)$/i,
        Videos: /\.(mp4|webm|ogg|mov|mkv|avi)$/i,
        Audio: /\.(mp3|wav|ogg|aac|m4a|flac)$/i,
        Archives: /\.(zip|rar|7z|tar|gz|bz2)$/i,
        Code: /\.(js|ts|py|java|cpp|c|h|html|css|json|xml|yml|yaml)$/i,
        Other: true // Fallback
    };

    const usage = {};
    Object.keys(categories).forEach(type => (usage[type] = 0));

    fileListData
        .filter(item => !item.is_folder && item.size)
        .forEach(file => {
            const name = file.name.toLowerCase();
            let matched = false;
            for (const [type, regex] of Object.entries(categories)) {
                if (type === 'Other') continue;
                if (regex.test(name)) {
                    usage[type] += file.size;
                    matched = true;
                    break;
                }
            }
            if (!matched) usage['Other'] += file.size;
        });

    // Prepare data for Chart.js
    const labels = Object.keys(usage).filter(type => usage[type] > 0);
    const data = labels.map(type => usage[type]);
    const colors = [
        '#4CAF50', '#2196F3', '#FF9800', '#E91E63',
        '#9C27B0', '#607D8B', '#FFEB3B'
    ].slice(0, labels.length);

    // Destroy old chart if exists
    if (storageChart) {
        storageChart.destroy();
    }

    storageChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Storage Usage (Bytes)',
                data: data,
                backgroundColor: colors,
                borderColor: colors.map(c => c + '55'),
                borderWidth: 1
            }]
        },
        options: {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: { display: false },
        tooltip: {
            bodyFont: { size: 12 },
            titleFont: { size: 13 },
            callbacks: {
                label: function(tooltipItem) {
                    const bytes = tooltipItem.raw;
                    return ` ${formatBytes(bytes)}`;
                }
            }
        }
    },
    scales: {
        x: {
            ticks: { font: { size: 10 } },
            title: { display: false }
        },
        y: {
            ticks: { font: { size: 11 } }
        }
    }
}
    });
}

    async function refreshFileSystem() {
        showLoader('Fetching files...');
        try {
            const { data, error } = await supabaseClient
                .from('files')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('is_folder', { ascending: false })
                .order('name', { ascending: true });

            if (error) throw error;

            allFiles = data;
            updateUsageMeter(data);
            fileSystem = buildFileSystemTree(data);

            if (currentPath !== 'root' && !findNodeByPath(currentPath, fileSystem)) {
                navigateTo('root');
            } else {
                navigateTo(currentPath);
            }
        } catch (error) {
            console.error('Error fetching file system:', error);
            alert('Could not load your files.');
        } finally {
            hideLoader();
        }
    }

    function buildFileSystemTree(flatList) {
        const rootNode = { name: "root", path: "root", is_folder: true, children: [] };
        const nodeMap = { "root": rootNode };

        flatList.forEach(item => {
            item.children = item.is_folder ? [] : null;
            nodeMap[item.path] = item;
        });

        flatList.forEach(item => {
            const parent = nodeMap[item.parent_path];
            if (parent) parent.children.push(item);
        });

        return rootNode;
    }

    function findNodeByPath(path, tree) {
        if (path === 'root') return tree;
        const parts = path.split('/').slice(1);
        let currentNode = tree;
        for (const part of parts) {
            const nextNode = currentNode.children.find(child => child.is_folder && child.name === part);
            if (nextNode) currentNode = nextNode;
            else return null;
        }
        return currentNode;
    }

    function initializeBrowserHistory() {
        const urlParams = new URLSearchParams(window.location.search);
        const initialPath = urlParams.get('path') || 'root';
        currentPath = initialPath;

        const initialState = { path: currentPath, page: 'fileStorage' };
        history.replaceState(initialState, '', `?path=${encodeURIComponent(currentPath)}`);

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.page === 'fileStorage') {
                isNavigatingFromHistory = true;
                navigateTo(event.state.path);
            } else {
                window.location.href = 'login.html';
            }
        });
    }

    function navigateTo(path) {
        const oldPath = currentPath;
        currentPath = path;
        selectedFile = null;
        selectedItems.clear();

        if (!isNavigatingFromHistory) {
            const state = { path: currentPath, page: 'fileStorage' };
            const url = `?path=${encodeURIComponent(currentPath)}`;
            history.pushState(state, '', url);
        } else {
            isNavigatingFromHistory = false;
        }

        renderView();
        backBtn.style.display = currentPath === 'root' ? 'none' : 'inline-block';
    }

    function renderView() {
        renderNavBar();
        renderFileList();
        renderPreview();
    }

    function renderNavBar() {
        const navBar = document.getElementById('navigation-bar');
        navBar.innerHTML = '';
        const parts = currentPath.split('/');
        let pathSoFar = '';
        parts.forEach((part, index) => {
            pathSoFar += (index > 0 ? '/' : '') + part;
            if (index > 0) {
                const separator = document.createElement('span');
                separator.className = 'nav-separator';
                separator.textContent = '>';
                navBar.appendChild(separator);
            }
            if (index < parts.length - 1) {
                const link = document.createElement('a');
                link.textContent = (part === 'root') ? 'Home' : part;
                link.className = 'nav-link';
                link.dataset.path = pathSoFar;
                link.onclick = () => navigateTo(pathSoFar);
                navBar.appendChild(link);
            } else {
                const current = document.createElement('span');
                current.textContent = (part === 'root') ? 'Home' : part;
                current.className = 'nav-current';
                navBar.appendChild(current);
            }
        });
    }

    function getFilteredFilesForSearch() {
        let filtered = allFiles;
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(item =>
                item.name.toLowerCase().includes(searchTerm)
            );
        }
        const filterType = filterSelect.value;
        if (filterType !== 'all') {
            switch (filterType) {
                case 'folders':
                    filtered = filtered.filter(item => item.is_folder);
                    break;
                case 'images':
                    filtered = filtered.filter(item => !item.is_folder && /\.(jpg|jpeg|png|gif)$/i.test(item.name));
                    break;
                case 'documents':
                    filtered = filtered.filter(item => !item.is_folder && /\.txt$/i.test(item.name));
                    break;
                case 'videos':
                    filtered = filtered.filter(item => !item.is_folder && /\.(mp4|webm|ogg)$/i.test(item.name));
                    break;
                case 'audio':
                    filtered = filtered.filter(item => !item.is_folder && /\.(mp3|wav|ogg)$/i.test(item.name));
                    break;
                case 'archives':
                    filtered = filtered.filter(item => !item.is_folder && /\.(zip|rar|7z|tar|gz)$/i.test(item.name));
                    break;
            }
        }
        return filtered.sort((a, b) => {
            if (a.is_folder !== b.is_folder) return a.is_folder ? -1 : 1;
            return a.name.localeCompare(b.name);
        });
    }

    function renderFileList() {
        const searchTerm = searchInput.value.trim();
        const isSearching = searchTerm.length > 0;

        fileList.innerHTML = '';

        if (isSearching) {
            const results = getFilteredFilesForSearch();
            if (results.length === 0) {
                fileList.innerHTML = '<p style="color: #999; text-align: center; margin-top: 20px;">No files found matching your search.</p>';
                return;
            }
            results.forEach(item => {
                renderFileItem(item);
            });
        } else {
            const node = findNodeByPath(currentPath, fileSystem);
            if (!node) {
                fileList.innerHTML = '<p>Folder not found.</p>';
                return;
            }
            const items = node.children || [];
            if (items.length === 0) {
                fileList.innerHTML = '<p style="color: #999; text-align: center;">This folder is empty.</p>';
                return;
            }
            items.forEach(item => {
                renderFileItem(item);
            });
        }
    }

    function renderFileItem(item) {
        const container = document.createElement('div');
        container.className = item.is_folder ? 'folder' : 'file-item';
        container.dataset.path = item.path;

        // Checkbox
        const checkboxContainer = document.createElement('div');
        checkboxContainer.className = 'checkbox-container';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = selectedItems.has(item.path);
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation();
            if (checkbox.checked) {
                selectedItems.add(item.path);
            } else {
                selectedItems.delete(item.path);
            }
        });
        checkboxContainer.appendChild(checkbox);
        container.appendChild(checkboxContainer);

        // Preview container
        const previewContainer = document.createElement('div');
        previewContainer.className = 'file-preview-container';

        const thumbnail = document.createElement('div');
        const fileName = item.name.toLowerCase();

        if (item.is_folder) {
            const icon = document.createElement('span');
            icon.className = 'folder-icon';
            icon.textContent = '📁';
            thumbnail.appendChild(icon);
        } else if (/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/.test(fileName)) {
            const img = document.createElement('img');
            img.className = 'thumbnail';
            img.alt = item.name;
            img.loading = "lazy";
            const storagePath = `${currentUser.id}/${item.path}`;
            const { data } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(storagePath);
            if (data?.publicUrl) img.src = data.publicUrl;
            else img.src = 'https://via.placeholder.com/60?text=img';
            img.onerror = () => { img.src = 'https://via.placeholder.com/60?text=err'; };
            thumbnail.appendChild(img);
        } else if (/\.(mp4|webm|ogg|mov|mkv)$/.test(fileName)) {
            const videoThumb = document.createElement('div');
            videoThumb.className = 'thumbnail-placeholder';
            videoThumb.innerHTML = `<div style="text-align:center;">▶<br><small>Video</small></div>`;
            thumbnail.appendChild(videoThumb);
        } else if (fileName.endsWith('.pdf')) {
            const pdfThumb = document.createElement('div');
            pdfThumb.className = 'thumbnail-placeholder';
            pdfThumb.innerHTML = `<div style="font-size:24px;">📄</div><small>PDF</small>`;
            thumbnail.appendChild(pdfThumb);
        } else if (/\.(mp3|wav|ogg|aac|m4a)$/.test(fileName)) {
            const audioThumb = document.createElement('div');
            audioThumb.className = 'thumbnail-placeholder';
            audioThumb.innerHTML = `<div style="font-size:24px;">🎵</div><small>Audio</small>`;
            thumbnail.appendChild(audioThumb);
        } else if (/\.(zip|rar|7z|tar|gz)$/.test(fileName)) {
            const archiveThumb = document.createElement('div');
            archiveThumb.className = 'thumbnail-placeholder';
            archiveThumb.innerHTML = `<div style="font-size:24px;">📦</div><small>ZIP</small>`;
            thumbnail.appendChild(archiveThumb);
        } else if (/\.(txt|md|json|js|css|html|py|java|ts|yml)$/.test(fileName)) {
            const textThumb = document.createElement('div');
            textThumb.className = 'thumbnail-placeholder';
            textThumb.innerHTML = `<div style="font-size:24px;">📝</div><small>${fileName.split('.').pop()}</small>`;
            thumbnail.appendChild(textThumb);
        } else {
            const fallbackThumb = document.createElement('div');
            fallbackThumb.className = 'thumbnail-placeholder';
            fallbackThumb.innerHTML = `<div style="font-size:24px;">📁</div><small>File</small>`;
            thumbnail.appendChild(fallbackThumb);
        }

        previewContainer.appendChild(thumbnail);
        const content = document.createElement('h3');
        content.textContent = item.name;
        previewContainer.appendChild(content);
        container.appendChild(previewContainer);

        // Actions
        const actions = document.createElement('div');
        actions.className = 'actions';
        const renameBtn = document.createElement('button');
        renameBtn.className = 'rename-btn';
        renameBtn.textContent = 'Rename';
        renameBtn.onclick = (e) => {
            e.stopPropagation();
            renameItem(item);
        };
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteItem(item);
        };
        actions.appendChild(renameBtn);
        actions.appendChild(deleteBtn);
        container.appendChild(actions);

        // Click and double-click
        container.onclick = (e) => {
            if (e.target === renameBtn || e.target === deleteBtn || e.target === checkbox) return;
            selectedFile = item;
            document.querySelectorAll('.folder.selected, .file-item.selected').forEach(el =>
                el.classList.remove('selected')
            );
            container.classList.add('selected');
            renderPreview();
        };

        container.ondblclick = (e) => {
            if (e.target === renameBtn || e.target === deleteBtn || e.target === checkbox) return;
            if (item.is_folder) {
                navigateTo(item.path);
            } else {
                const storagePath = `${currentUser.id}/${item.path}`;
                const { data } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(storagePath);
                if (data?.publicUrl) {
                    window.open(data.publicUrl, '_blank');
                }
            }
        };

        fileList.appendChild(container);
    }

    // === BULK ZIP EXPORT ===
    exportZipBtn.addEventListener('click', async () => {
        if (selectedItems.size === 0) {
            alert("Please select at least one file or folder to export.");
            return;
        }
        await downloadSelectedAsZip();
    });

    async function downloadSelectedAsZip() {
    showLoader(`Creating ZIP with ${selectedItems.size} items...`);
    const zip = new JSZip();

    try {
        const promises = Array.from(selectedItems).map(async (path) => {
            const item = allFiles.find(f => f.path === path);
            if (!item) return;

            if (item.is_folder) {
                const folderNode = findNodeByPath(path, fileSystem);
                await addFolderToZip(zip, folderNode, item.name);
            } else {
                const storagePath = `${currentUser.id}/${item.path}`;
                const { data: downloadData, error } = await supabaseClient.storage.from(BUCKET_NAME).download(storagePath);
                if (error) throw new Error(`Download failed for ${item.name}: ${error.message}`);
                // downloadData is already a Blob, no need to call .blob()
                zip.file(item.name, downloadData);
            }
        });

        await Promise.all(promises);
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = `export_${new Date().toISOString().slice(0, 10)}.zip`;
        link.click();
        URL.revokeObjectURL(link.href);
    } catch (error) {
        console.error('ZIP creation failed:', error);
        alert('Failed to create ZIP file: ' + error.message);
    } finally {
        hideLoader();
    }
}

    async function addFolderToZip(zipFolder, node, folderName) {
    const dir = zipFolder.folder(folderName);
    for (const item of node.children) {
        if (item.is_folder) {
            const subNode = findNodeByPath(item.path, fileSystem);
            await addFolderToZip(dir, subNode, item.name);
        } else {
            const storagePath = `${currentUser.id}/${item.path}`;
            const { data: downloadData, error } = await supabaseClient.storage.from(BUCKET_NAME).download(storagePath);
            if (error) throw new Error(`Download failed for ${item.name}: ${error.message}`);
            dir.file(item.name, downloadData); // downloadData is Blob
        }
    }
}

    // === REST OF YOUR FUNCTIONS ===
    function renderPreview() {
        if (!selectedFile) {
            const node = findNodeByPath(currentPath, fileSystem);
            if (!node) return;
            previewHeader.textContent = `Contents of "${node.name}"`;
            previewContent.innerHTML = '';
            if (node.children.length === 0) {
                previewContent.innerHTML = '<p><em>No items in this folder.</em></p>';
                return;
            }
            const ul = document.createElement('ul');
            node.children.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${item.is_folder ? '📁' : '📄'}</strong> ${item.name}`;
                if (!item.is_folder && item.size) {
                    li.innerHTML += ` <span style="color: #888;">(${formatBytes(item.size)})</span>`;
                }
                ul.appendChild(li);
            });
            previewContent.appendChild(ul);
            return;
        }

        previewHeader.textContent = selectedFile.name;
        previewContent.innerHTML = '';

        if (selectedFile.is_folder) {
            const summary = document.createElement('div');
            summary.className = 'preview-folder-summary';
            const folderNode = findNodeByPath(selectedFile.path, fileSystem);
            const fileCount = folderNode.children.filter(f => !f.is_folder).length;
            const folderCount = folderNode.children.filter(f => f.is_folder).length;
            summary.innerHTML = `
                <p><strong>Type:</strong> Folder</p>
                <p><strong>Path:</strong> ${selectedFile.path}</p>
                <p><strong>Contains:</strong> ${folderCount} folders, ${fileCount} files</p>
            `;
            previewContent.appendChild(summary);
        } else {
            const storagePath = `${currentUser.id}/${selectedFile.path}`;
            const fileName = selectedFile.name.toLowerCase();

            if (/\.(jpg|jpeg|png|gif|bmp|svg|webp)$/i.test(fileName)) {
                const img = document.createElement('img');
                const { data } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(storagePath);
                if (data?.publicUrl) {
                    img.src = data.publicUrl;
                    img.alt = selectedFile.name;
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '6px';
                    img.style.border = '1px solid #ddd';
                    img.onerror = () => {
                        const errorMsg = document.createElement('p');
                        errorMsg.textContent = 'Could not load image.';
                        errorMsg.style.color = '#999';
                        previewContent.appendChild(errorMsg);
                    };
                    previewContent.appendChild(img);
                } else {
                    previewContent.innerHTML = '<p style="color: #999;">Could not load image.</p>';
                }
            } else if (fileName.endsWith('.pdf')) {
                const iframe = document.createElement('iframe');
                const { data } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(storagePath);
                if (data?.publicUrl) {
                    iframe.src = data.publicUrl;
                    iframe.style.width = '100%';
                    iframe.style.height = '500px';
                    iframe.style.border = 'none';
                    iframe.style.borderRadius = '6px';
                    previewContent.appendChild(iframe);
                } else {
                    previewContent.innerHTML = '<p style="color: #999;">Could not load PDF.</p>';
                }
            } else if (/\.(mp4|webm|ogg|avi|mov|mkv)$/i.test(fileName)) {
                const video = document.createElement('video');
                video.controls = true;
                video.style.width = '100%';
                video.style.maxHeight = '400px';
                video.style.borderRadius = '6px';
                const { data } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(storagePath);
                if (data?.publicUrl) {
                    video.src = data.publicUrl;
                    video.onerror = () => {
                        previewContent.innerHTML = '<p style="color: #999;">Could not load video.</p>';
                    };
                } else {
                    previewContent.innerHTML = '<p style="color: #999;">Could not load video.</p>';
                }
                previewContent.appendChild(video);
            } else if (/\.(mp3|wav|ogg|aac|flac|m4a)$/i.test(fileName)) {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.style.width = '100%';
                audio.style.marginTop = '20px';
                const { data } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(storagePath);
                if (data?.publicUrl) {
                    audio.src = data.publicUrl;
                    audio.onerror = () => {
                        previewContent.innerHTML = '<p style="color: #999;">Could not load audio.</p>';
                    };
                } else {
                    previewContent.innerHTML = '<p style="color: #999;">Could not load audio.</p>';
                }
                const audioInfo = document.createElement('div');
                audioInfo.innerHTML = `
                    <p><strong>Audio File:</strong> ${selectedFile.name}</p>
                    <p><strong>Size:</strong> ${formatBytes(selectedFile.size)}</p>
                `;
                audioInfo.style.marginBottom = '15px';
                previewContent.appendChild(audioInfo);
                previewContent.appendChild(audio);
            } else if (/\.(txt|md|csv|log|json|js|css|html|xml|py|java|cpp|c|h|php|rb|go|rs|swift|kt|ts|yml|yaml|ini|cfg|conf)$/i.test(fileName)) {
                const textarea = document.createElement('textarea');
                textarea.readOnly = true;
                textarea.style.width = '100%';
                textarea.style.height = '400px';
                textarea.style.border = '1px solid #ddd';
                textarea.style.borderRadius = '4px';
                textarea.style.padding = '10px';
                textarea.style.fontFamily = 'Consolas, Monaco, "Courier New", monospace';
                textarea.style.fontSize = '13px';
                textarea.style.resize = 'vertical';
                textarea.textContent = "Loading...";
                previewContent.appendChild(textarea);

                supabaseClient.storage.from(BUCKET_NAME).download(storagePath)
                    .then(({ data, error }) => {
                        if (error) throw error;
                        return data.text();
                    })
                    .then(text => {
                        textarea.value = text;
                        if (/\.(js|json|css|html|xml|py|java|cpp|c|h|php|rb|go|rs|swift|kt|ts)$/i.test(fileName)) {
                            textarea.style.backgroundColor = '#f8f8f8';
                        }
                    })
                    .catch(err => {
                        textarea.value = "Error loading content: " + err.message;
                        textarea.style.color = '#999';
                        console.error('Error:', err);
                    });
            } else {
                const { data } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(storagePath);
                const fileExt = fileName.split('.').pop().toUpperCase();
                previewContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📄</div>
                        <p><strong>File:</strong> ${selectedFile.name}</p>
                        <p><strong>Size:</strong> ${formatBytes(selectedFile.size)}</p>
                        <p><strong>Type:</strong> ${fileExt}</p>
                        <p style="color: #666; margin: 20px 0;">Preview not available.</p>
                        <a href="${data?.publicUrl}" download="${selectedFile.name}" target="_blank"
                           style="background: #2e86de; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">
                           Download File
                        </a>
                    </div>
                `;
            }
        }
    }

    // === EVENT LISTENERS ===
    backBtn.addEventListener('click', () => {
        if (currentPath === 'root') return;
        const parts = currentPath.split('/');
        parts.pop();
        navigateTo(parts.join('/') || 'root');
    });
    backBtn.style.display = 'none';

    searchInput.addEventListener('input', renderFileList);
    filterSelect.addEventListener('change', renderFileList);

    openModalBtn.addEventListener('click', () => {
        updateFolderSelection();
        if (folderSelect.querySelector(`option[value="${currentPath}"]`)) {
            folderSelect.value = currentPath;
        }
        uploadModal.style.display = 'flex';
    });

    document.getElementById('closeModalBtn').onclick = () => {
        uploadModal.style.display = 'none';
        resetInputs();
    };

    createFolderBtn.addEventListener('click', async () => {
        const folderName = prompt("Enter folder name (cannot contain '/'):");
        if (!folderName || folderName.includes('/')) {
            if (folderName) alert("Folder name cannot contain '/'");
            return;
        }
        const parentPath = currentPath;
        const newPath = `${parentPath}/${folderName}`;
        showLoader('Creating folder...');
        try {
            const { error: insertError } = await supabaseClient.from('files').insert({
                user_id: currentUser.id,
                name: folderName,
                path: newPath,
                is_folder: true,
                parent_path: parentPath
            });
            if (insertError) throw insertError;
            await refreshFileSystem();
        } catch (error) {
            console.error('Error creating folder:', error);
            alert('Failed to create folder.');
        } finally {
            hideLoader();
        }
    });

    async function uploadFiles(files, parentPath) {
        if (!files.length) return;
        showLoader(`Uploading ${files.length} file(s)...`);
        let successCount = 0;
        let errorCount = 0;
        for (const file of files) {
            const finalName = file.name;
            const newPath = `${parentPath}/${finalName}`;
            const storagePath = `${currentUser.id}/${newPath}`;
            try {
                const { data: existing, error: checkError } = await supabaseClient
                    .from('files').select('id').eq('parent_path', parentPath).eq('name', finalName).single();
                if (checkError && checkError.code !== 'PGRST116') throw checkError;
                if (existing) {
                    alert(`File "${finalName}" already exists.`);
                    continue;
                }
                const { error: uploadError } = await supabaseClient.storage.from(BUCKET_NAME).upload(storagePath, file);
                if (uploadError) throw uploadError;
                const { error: insertError } = await supabaseClient.from('files').insert({
                    user_id: currentUser.id,
                    name: finalName,
                    path: newPath,
                    is_folder: false,
                    parent_path: parentPath,
                    size: file.size
                });
                if (insertError) {
                    await supabaseClient.storage.from(BUCKET_NAME).remove([storagePath]);
                    throw insertError;
                }
                successCount++;
            } catch (err) {
                console.error('Upload failed:', err);
                errorCount++;
            }
        }
        const message = `${successCount} file(s) uploaded successfully.` +
            (errorCount > 0 ? `\n${errorCount} file(s) failed.` : '');
        alert(message);
        uploadModal.style.display = 'none';
        resetInputs();
        await refreshFileSystem();
        hideLoader();
    }

    uploadBtn.addEventListener('click', () => {
        const files = fileInput.files;
        if (!files.length) {
            alert('Select files first.');
            return;
        }
        uploadFiles(files, folderSelect.value);
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });
    dropZone.addEventListener('dragenter', () => dropZone.classList.add('dragover'), false);
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'), false);
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'), false);
    dropZone.addEventListener('drop', (e) => {
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        uploadFiles(files, currentPath);
    }, false);

    async function renameItem(item) {
        const nameWithoutExt = item.name.split('.').slice(0, -1).join('.');
        const currentName = item.is_folder ? item.name : nameWithoutExt;
        const newNameRaw = prompt(`Enter new name for "${item.name}":`, currentName);
        if (!newNameRaw || newNameRaw === currentName || newNameRaw.includes('/')) {
            if (newNameRaw) alert("Invalid name or name unchanged.");
            return;
        }
        showLoader('Renaming...');
        try {
            if (item.is_folder) {
                await renameFolder(item, newNameRaw);
            } else {
                await renameFile(item, newNameRaw);
            }
            await refreshFileSystem();
        } catch (error) {
            console.error('Rename failed:', error);
            alert(`Could not rename item: ${error.message}`);
        } finally {
            hideLoader();
        }
    }

    async function renameFile(item, newNameRaw) {
        const ext = item.name.includes('.') ? `.${item.name.split('.').pop()}` : '';
        const newName = `${newNameRaw}${ext}`;
        const { data: existing, error: checkError } = await supabaseClient
            .from('files').select('id').eq('parent_path', item.parent_path).eq('name', newName).single();
        if (checkError && checkError.code !== 'PGRST116') throw checkError;
        if (existing) throw new Error('A file with that name already exists in this folder.');
        const newPath = `${item.parent_path}/${newName}`;
        const oldStoragePath = `${currentUser.id}/${item.path}`;
        const newStoragePath = `${currentUser.id}/${newPath}`;
        const { error: moveError } = await supabaseClient.storage.from(BUCKET_NAME).move(oldStoragePath, newStoragePath);
        if (moveError) throw moveError;
        const { error: updateError } = await supabaseClient
            .from('files').update({ name: newName, path: newPath }).eq('id', item.id);
        if (updateError) {
            await supabaseClient.storage.from(BUCKET_NAME).move(newStoragePath, oldStoragePath);
            throw updateError;
        }
    }

    async function renameFolder(item, newName) {
        const { data: existing, error: checkError } = await supabaseClient
            .from('files').select('id').eq('parent_path', item.parent_path).eq('name', newName).eq('is_folder', true).single();
        if (checkError && checkError.code !== 'PGRST116') throw checkError;
        if (existing) throw new Error('A folder with that name already exists here.');
        const oldPath = item.path;
        const newPath = `${item.parent_path}/${newName}`;
        const { data: descendants, error: fetchError } = await supabaseClient
            .from('files').select('*').like('path', `${oldPath}/%`);
        if (fetchError) throw fetchError;
        const filesToMove = descendants.filter(d => !d.is_folder);
        if (filesToMove.length > 0) {
            const movePromises = filesToMove.map(file => {
                const fileNewPath = file.path.replace(oldPath, newPath);
                return supabaseClient.storage.from(BUCKET_NAME).move(
                    `${currentUser.id}/${file.path}`,
                    `${currentUser.id}/${fileNewPath}`
                );
            });
            const moveResults = await Promise.all(movePromises);
            const firstMoveError = moveResults.find(res => res.error);
            if (firstMoveError) {
                throw new Error(`Failed to move a file in storage: ${firstMoveError.error.message}`);
            }
        }
        const recordsToUpdate = [item, ...descendants].map(record => ({
            id: record.id,
            user_id: currentUser.id,
            name: record.id === item.id ? newName : record.name,
            path: record.path.replace(oldPath, newPath),
            parent_path: record.parent_path.replace(oldPath, newPath),
        }));
        const { error: updateError } = await supabaseClient.from('files').upsert(recordsToUpdate);
        if (updateError) {
            throw new Error(`Database update failed: ${updateError.message}`);
        }
    }

    async function deleteItem(item) {
        if (!confirm(`Are you sure you want to delete "${item.name}"? This cannot be undone.`)) return;
        showLoader('Deleting...');
        try {
            let filesToDeleteFromStorage = [];
            let recordsToDeleteFromDb = [item.id];
            if (item.is_folder) {
                const { data: descendants, error } = await supabaseClient.from('files').select('id, path, is_folder').like('path', `${item.path}/%`);
                if (error) throw error;
                descendants.forEach(d => {
                    recordsToDeleteFromDb.push(d.id);
                    if (!d.is_folder) {
                        filesToDeleteFromStorage.push(`${currentUser.id}/${d.path}`);
                    }
                });
            } else {
                filesToDeleteFromStorage.push(`${currentUser.id}/${item.path}`);
            }
            if (filesToDeleteFromStorage.length > 0) {
                const { error: storageError } = await supabaseClient.storage.from(BUCKET_NAME).remove(filesToDeleteFromStorage);
                if (storageError) console.warn("Could not delete from storage:", storageError.message);
            }
            const { error: dbError } = await supabaseClient.from('files').delete().in('id', recordsToDeleteFromDb);
            if (dbError) throw dbError;
            if (selectedFile && selectedFile.id === item.id) {
                selectedFile = null;
            }
            await refreshFileSystem();
        } catch (error) {
            console.error('Error deleting item:', error);
            alert(`Could not delete item: ${error.message}`);
        } finally {
            hideLoader();
        }
    }

    function updateFolderSelection() {
        folderSelect.innerHTML = '<option value="root">Root</option>';
        function addOptions(folder, prefix = '') {
            folder.children.forEach(item => {
                if (item.is_folder) {
                    const option = document.createElement('option');
                    option.value = item.path;
                    option.textContent = `${prefix}${item.name}`;
                    folderSelect.appendChild(option);
                    addOptions(item, `${prefix}${item.name}/`);
                }
            });
        }
        addOptions(fileSystem);
    }

    function resetInputs() {
        fileInput.value = '';
    }

    logoutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = 'login.html';
    });

    window.addEventListener('click', (e) => {
        if (e.target === uploadModal) {
            uploadModal.style.display = 'none';
            resetInputs();
        }
    });
    // === STORAGE WIDGET TOGGLE ===
const storageWidget = document.getElementById('storageWidget');
const storageWidgetToggle = document.getElementById('storageWidgetToggle');
let isWidgetOpen = true;

storageWidgetToggle.addEventListener('click', () => {
    if (isWidgetOpen) {
        storageWidget.style.maxHeight = '40px';
        storageWidget.style.opacity = 0.8;
        storageWidgetToggle.textContent = '📊';
    } else {
        storageWidget.style.maxHeight = '300px';
        storageWidget.style.opacity = 1;
        storageWidgetToggle.textContent = '❌';
    }
    isWidgetOpen = !isWidgetOpen;
});
</script>
<!-- Floating Storage Widget -->
<div id="storageWidget" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 360px;
    max-height: 300px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    overflow: hidden;
    z-index: 1000;
    transition: max-height 0.4s ease, opacity 0.3s ease;
    opacity: 1;
">
    <!-- Toggle Button -->
    <div id="storageWidgetToggle" style="
        position: absolute;
        top: -30px;
        right: 0;
        width: 30px;
        height: 30px;
        background: #2e86de;
        color: white;
        border-radius: 5px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    ">📊</div>

    <!-- Content -->
    <div id="storageWidgetContent" style="padding: 15px;">
        <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">Storage Usage</h3>
        <div id="usageText" style="font-weight: bold; color: #555; font-size: 12px;">Calculating...</div>
        <div class="progress-bar-background" style="
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            height: 12px;
            margin: 8px 0;
            overflow: hidden;
        ">
            <div id="usageProgressBar" class="progress-bar-foreground" style="
                width: 0%;
                height: 100%;
                background-color: #2e86de;
                border-radius: 5px;
                transition: width 0.5s ease-in-out;
            "></div>
        </div>
        <div style="height: 150px; margin-top: 10px;">
            <canvas id="storageChart"></canvas>
        </div>
    </div>
</div>
</body>

</html>